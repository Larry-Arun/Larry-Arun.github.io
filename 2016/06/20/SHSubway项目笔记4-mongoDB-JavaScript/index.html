<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> SHSubway项目笔记4-mongoDB+JavaScript · Mia</title><meta name="description" content="SHSubway项目笔记4-mongoDB+JavaScript - Mia Wang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/iridescentmia" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://iridescentmia.github.io/resume/" target="_blank" class="nav-list-link">RESUME</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">SHSubway项目笔记4-mongoDB+JavaScript</h1><div class="post-info">Jun 20, 2016</div><div class="post-content"><p>目录结构</p>
<ul>
<li>1.mongoDB执行js脚本</li>
<li>2.mongoDB大量删除数据空间释放问题</li>
<li>3.JavaScript中深复制和浅复制</li>
</ul>
<a id="more"></a>
<h3 id="1-mongoDB执行js脚本"><a href="#1-mongoDB执行js脚本" class="headerlink" title="1.mongoDB执行js脚本 "></a><strong>1.mongoDB执行js脚本 </strong></h3><p>一直用roboMongo做mongoDB的管理，界面很清晰很好用，直到执行运行时间很久很耗内存的命令，roboMongo一次又一次的崩溃，发现还是shell靠谱抗造。</p>
<p>mongoDB的shell是JavaScript实现的，用shell执行js脚本方便稳定。</p>
<ul>
<li>将js脚本保存到mongoDB的bin目录下</li>
<li>命令行工具进入bin目录，执行以下操作</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">27017</span>/dbName –quiet test.js</span><br></pre></td></tr></table></figure>
<p>然后就静静的等待运行结束吧~</p>
<p>【参考】<br><a href="http://blog.csdn.net/zzq900503/article/details/46414115" target="_blank" rel="external">mongodb执行js脚本(一)—shell执行</a></p>
<h3 id="2-mongoDB大量删除数据空间释放问题"><a href="#2-mongoDB大量删除数据空间释放问题" class="headerlink" title="2.mongoDB大量删除数据空间释放问题"></a><strong>2.mongoDB大量删除数据空间释放问题</strong></h3><p>在删除数据的过程中，发现一个奇怪的现象，原本数据库25.5G，有413562171个文档。我执行了下面的操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collectionName.remove( &#123; xxx: <span class="string">"xxx"</span> &#125; )</span><br></pre></td></tr></table></figure>
<p>这个操作删除了165540416个文档之后，数据库的大小竟然不减反加，变成25.8G。这让我非常困惑。</p>
<p>【原因】<br>在Stack Overflow提问，原来是mongoDB不会自动释放空间，它认为这些空间在以后新建文档的时候还能用到。</p>
<p>【手动释放空间】<br>如果想释放这些空间，可以使用repairDatabase</p>
<p>mongo shell命令为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.repairDatabase()</span><br></pre></td></tr></table></figure></p>
<p>或者命令行工具在mongoDB安装bin目录下执行<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --repair</span><br></pre></td></tr></table></figure></p>
<p>【参考】<br><a href="http://stackoverflow.com/questions/37499195/why-the-mongodb-database-take-more-space-after-removing-documents" target="_blank" rel="external">Why the mongodb database take more space after removing documents</a></p>
<h3 id="3-JavaScript中深复制和浅复制"><a href="#3-JavaScript中深复制和浅复制" class="headerlink" title="3.JavaScript中深复制和浅复制"></a><strong>3.JavaScript中深复制和浅复制</strong></h3><p>先看如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> original = &#123;&#125;;</span><br><span class="line">original.a = <span class="string">'abc'</span>;</span><br><span class="line"><span class="keyword">var</span> copy = original;</span><br><span class="line">copy.a = <span class="string">'xxx'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(original.a);<span class="comment">// 输出xxx</span></span><br></pre></td></tr></table></figure>
<p>新建对象copy，并将对象original赋值给对象copy，然后修改copy的属性a，发现对象original的属性被改变。</p>
<p>【原因】<br>因为JavaScript存储对象都是存地址的，所以以上复制会导致original和copy指向同一块内存地址，以上对象的复制方式为浅复制。</p>
<p>如果想复制后修改属性，而不改变原对象属性值，可以采用深复制方式，开辟一块新的内存地址，将原对象的各个属性<strong>逐个复制</strong>过去。</p>
<p>深复制可以使用jQuery的$.extend()函数实现，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = &#123;</span><br><span class="line">    a: <span class="number">1</span>,</span><br><span class="line">    b: &#123; f: &#123; g: <span class="number">1</span> &#125; &#125;,</span><br><span class="line">    c: [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> ]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> y = $.extend(&#123;&#125;, x),        <span class="comment">// 浅复制</span></span><br><span class="line">    z = $.extend(<span class="literal">true</span>, &#123;&#125;, x); <span class="comment">// 深复制</span></span><br><span class="line"></span><br><span class="line">y.b.f === x.b.f       <span class="comment">// true</span></span><br><span class="line">z.b.f === x.b.f       <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<p>【参考】</p>
<p><a href="https://www.zhihu.com/question/23031215" target="_blank" rel="external">javascript中的深拷贝和浅拷贝？</a><br><a href="http://jerryzou.com/posts/dive-into-deep-clone-in-javascript/" target="_blank" rel="external">深入剖析 JavaScript 的深复制</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/07/03/一个Flex布局的实例/" class="prev">PREV</a><a href="/2016/06/16/小tips-CSS篇1/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://yoursite.com">Mia Wang</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>